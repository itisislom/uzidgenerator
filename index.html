<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор ID-карты Узбекистана</title>
    <link rel="icon" type="image/png" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .id-card-container {
            width: 3.375in; /* ~85.6mm */
            height: 2.125in; /* ~53.98mm */
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem;
            border: 1px solid #e2e8f0;
            background-color: #fff;
            color: #000;
        }
        .modern-button {
            background-color: transparent;
            color: #059669;
            padding: 0.6rem 1.2rem;
            border-radius: 9999px;
            cursor: pointer;
            display: inline-block;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.15s ease-out;
            border: 2px solid #059669;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 4px #047857;
            position: relative;
            top: 0;
        }
        .modern-button:hover { background-color: #059669; color: #fff; top: 2px; box-shadow: 0 2px #047857; }
        .modern-button:active { top: 4px; box-shadow: 0 0 #047857; }

        .uz-flag { width: 100%; height: 10px; position: absolute; top: 0; left: 0; display: flex; }
        .uz-flag .blue { background-color: #0072CE; flex: 2; }
        .uz-flag .white { background-color: #FFFFFF; flex: 3; }
        .uz-flag .green { background-color: #11A63F; flex: 2; }
        /* добавим тонкую красную разделительную линию (как деталь дизайна) */
        .uz-flag .divider { width: 2px; background-color: #D62615; }

        .custom-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            z-index: 999;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .custom-modal {
            background-color: #fff;
            padding: 18px 22px;
            border-radius: 8px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.18);
            z-index: 1000;
            text-align: center;
            color: #111827;
            transform: translateY(8px);
            opacity: 0;
            transition: all .22s ease;
            min-width: 220px;
        }
        .custom-modal.show { transform: translateY(0); opacity: 1; }

        .photo-container { position: relative; max-width: 3.7rem; max-height: 4.7rem; flex-shrink: 0; }
        .photo-container img { width: 100%; height: 100%; object-fit: contain; display: block; background: #f3f4f6; }
    </style>
</head>
<body class="font-sans bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">
    <div class="flex flex-col lg:flex-row bg-white rounded-lg shadow-xl overflow-hidden w-full max-w-6xl">
        <div class="w-full lg:w-1/2 p-6 md:p-8 space-y-6 border-r border-gray-200 overflow-y-auto" style="max-height: 90vh;">
            <div class="flex justify-end mb-4">
                <select id="languageSelector" class="px-3 py-2 border rounded-md shadow-sm">
                    <option value="ru">Русский</option>
                    <option value="uz">O'zbekcha</option>
                </select>
            </div>

            <h2 id="editorTitle" class="text-3xl font-bold text-gray-800 mb-6 text-center">Редактор ID-карты</h2>

            <div class="space-y-4">
                <label id="photoLabel" for="studentPhotoUpload" class="block text-sm font-medium text-gray-700">Загрузить фото паспорта</label>
                <label for="studentPhotoUpload" class="modern-button">Выбрать файл</label>
                <input type="file" id="studentPhotoUpload" accept="image/*" class="hidden">
            </div>

            <div class="space-y-4">
                <label id="surnameLabel" for="surnameInput" class="block text-sm font-medium text-gray-700">Фамилия (Familiyasi):</label>
                <input type="text" id="surnameInput" placeholder="Olimjonova" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm sm:text-sm">
            </div>

            <div class="space-y-4">
                <label id="nameLabel" for="nameInput" class="block text-sm font-medium text-gray-700">Имя (Ismi):</label>
                <input type="text" id="nameInput" placeholder="Nilufar" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm sm:text-sm">
            </div>
            
            <div class="space-y-4">
                <label id="dobLabel" for="dobInput" class="block text-sm font-medium text-gray-700">Дата рождения (Tug'ilgan sana):</label>
                <input type="date" id="dobInput" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm sm:text-sm">
            </div>

            <div class="space-y-4">
                <label id="sexLabel" for="sexInput" class="block text-sm font-medium text-gray-700">Пол (Jinsi):</label>
                <select id="sexInput" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm sm:text-sm">
                    <option value="AYOL">Женский (AYOL)</option>
                    <option value="ERKAK">Мужской (ERKAK)</option>
                </select>
            </div>

            <div class="space-y-4">
                <label id="issueDateLabel" for="issueDateInput" class="block text-sm font-medium text-gray-700">Дата выдачи (Berilgan sanasi):</label>
                <input type="date" id="issueDateInput" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm sm:text-sm">
            </div>

            <div class="space-y-4">
                <label id="expiryDateLabel" for="expiryDateInput" class="block text-sm font-medium text-gray-700">Срок действия (Amal qilish vaqti):</label>
                <input type="date" id="expiryDateInput" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm sm:text-sm">
            </div>
            
            <div class="space-y-4">
                <label id="cardNumberLabel" for="cardNumberInput" class="block text-sm font-medium text-gray-700">Номер карты (Karta raqami):</label>
                <input type="text" id="cardNumberInput" placeholder="1234567" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm sm:text-sm">
            </div>

            <div class="space-y-4">
                <label id="idUzbLabel" for="idUzbInput" class="block text-sm font-medium text-gray-700">Текст ID UZB:</label>
                <input type="text" id="idUzbInput" value="ID UZB" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm sm:text-sm">
            </div>
        </div>

        <div class="w-full lg:w-1/2 p-6 md:p-8 flex flex-col items-center justify-center bg-gray-50 relative">
            <h2 id="previewTitle" class="text-3xl font-bold text-gray-800 mb-6 text-center">Предпросмотр ID-карты</h2>

            <div id="idCardPreview" class="id-card-container bg-white rounded-lg shadow-lg relative" aria-label="Предварительный просмотр карты">
                <div class="uz-flag">
                    <div class="blue"></div>
                    <div class="divider"></div>
                    <div class="white"></div>
                    <div class="divider"></div>
                    <div class="green"></div>
                </div>

                <div class="absolute top-2 left-0 w-full flex items-center justify-between px-2 text-[0.4rem] font-medium text-gray-800">
                    <div class="flex flex-col items-start">
                        <p id="cardHeader1" class="font-bold text-[0.6rem] whitespace-nowrap">O'ZBEKISTON RESPUBLIKASI</p>
                        <p id="cardHeader2" class="whitespace-nowrap">SHAXS GUVOHNOMASI</p>
                    </div>
                    <div class="flex items-center space-x-1">
                        <img src="https://placehold.co/10x10/E0E7FF/047857?text=H" alt="Hologram" class="w-3 h-3">
                        <p id="cardIdUzb" class="font-bold text-[0.7rem]">ID UZB</p>
                    </div>
                </div>

                <div class="flex flex-row w-full mt-8 flex-grow p-1">
                    <div class="photo-container w-20 h-24 flex-shrink-0 bg-gray-200 rounded-md overflow-hidden relative mr-2">
                        <img id="cardStudentPhoto" src="https://placehold.co/100x120/10B981/ffffff?text=Фото" alt="Фото паспорта" class="w-full h-full object-contain" crossorigin="anonymous">
                    </div>
                    
                    <div class="flex flex-col text-[0.5rem] space-y-0.5 flex-grow font-bold pl-1">
                        <p id="cardSurnameLabel" class="text-xs text-gray-500 font-normal">Familiyasi / Surname</p>
                        <p id="cardSurname" class="text-sm font-bold -mt-1"></p>

                        <p id="cardNameLabel" class="text-xs text-gray-500 font-normal">Ismi / Given name</p>
                        <p id="cardName" class="text-sm font-bold -mt-1"></p>
                        
                        <div class="flex justify-between items-start">
                            <div class="flex flex-col">
                                <p id="cardDobLabel" class="text-xs text-gray-500 font-normal">Tug'ilgan sana / Date of birth</p>
                                <p id="cardDob" class="text-xs font-bold -mt-1"></p>
                            </div>
                            <div class="flex flex-col text-right">
                                <p id="cardSexLabel" class="text-xs text-gray-500 font-normal">Jinsi / Sex</p>
                                <p id="cardSex" class="text-xs font-bold -mt-1"></p>
                            </div>
                        </div>

                        <p id="cardIssueDateLabel" class="text-xs text-gray-500 font-normal">Berilgan sanasi / Date of issue</p>
                        <p id="cardIssueDate" class="text-xs font-bold -mt-1"></p>

                        <p id="cardExpiryDateLabel" class="text-xs text-gray-500 font-normal">Amal qilish vaqti / Date of expiry</p>
                        <p id="cardExpiryDate" class="text-xs font-bold -mt-1"></p>
                    </div>
                </div>

                <div class="flex items-center justify-between w-full px-2 py-0.5 border-t border-gray-200 text-xs text-gray-500">
                    <div class="flex flex-col">
                        <p id="cardCardNumberLabel">Karta raqami / Card number</p>
                        <p id="cardCardNumber" class="font-bold -mt-1"></p>
                    </div>
                    <img src="https://placehold.co/50x15/E0E7FF/047857?text=Hologram" alt="Hologram" class="w-16 h-auto">
                </div>
            </div>

            <button id="downloadCardButton" class="modern-button mt-8">
                Скачать карту
            </button>
        </div>
    </div>
    
    <div id="modalOverlay" class="custom-modal-overlay" role="dialog" aria-modal="true">
        <div id="modalBox" class="custom-modal"></div>
    </div>

    <footer class="w-full text-center text-sm text-gray-500 mt-8 mb-4">
        &copy; Copyright Islom Sadriddinov сайта. Все права защищены.
    </footer>

    <script>
        // Переводы
        const translations = {
            ru: {
                editorTitle: "Редактор ID-карты",
                previewTitle: "Предпросмотр ID-карты",
                photoLabel: "Загрузить фото паспорта",
                chooseFile: "Выбрать файл",
                surnameLabel: "Фамилия (Familiyasi):",
                nameLabel: "Имя (Ismi):",
                dobLabel: "Дата рождения (Tug'ilgan sana):",
                sexLabel: "Пол (Jinsi):",
                issueDateLabel: "Дата выдачи (Berilgan sanasi):",
                expiryDateLabel: "Срок действия (Amal qilish vaqti):",
                cardNumberLabel: "Номер карты (Karta raqami):",
                idUzbLabel: "Текст ID UZB:",
                sexFemale: "Женский (AYOL)",
                sexMale: "Мужской (ERKAK)",
                downloadButton: "Скачать карту",
                creatingCard: "Создаю вашу карту...",
                downloadSuccess: "Карта загружена как PNG и PDF!",
                downloadError: "Не удалось создать карту. Проверьте консоль на наличие ошибок.",
                uzbekFlag1: "O'ZBEKISTON RESPUBLIKASI",
                uzbekFlag2: "SHAXS GUVOHNOMASI",
                uzbekSurname: "Familiyasi / Surname",
                uzbekName: "Ismi / Given name",
                uzbekDob: "Tug'ilgan sana / Date of birth",
                uzbekSex: "Jinsi / Sex",
                uzbekIssueDate: "Berilgan sanasi / Date of issue",
                uzbekExpiryDate: "Amal qilish vaqti / Date of expiry",
                uzbekCardNumber: "Karta raqami / Card number",
                placeholderPhoto: "Фото",
            },
            uz: {
                editorTitle: "ID-kartani tahrirlash",
                previewTitle: "ID-kartani ko'rish",
                photoLabel: "Pasport rasmini yuklash",
                chooseFile: "Faylni tanlash",
                surnameLabel: "Familiyasi:",
                nameLabel: "Ismi:",
                dobLabel: "Tug'ilgan sana:",
                sexLabel: "Jinsi:",
                issueDateLabel: "Berilgan sanasi:",
                expiryDateLabel: "Amal qilish vaqti:",
                cardNumberLabel: "Karta raqami:",
                idUzbLabel: "ID UZB matni:",
                sexFemale: "Ayol (AYOL)",
                sexMale: "Erkak (ERKAK)",
                downloadButton: "Kartani yuklash",
                creatingCard: "Kartangiz yaratilmoqda...",
                downloadSuccess: "Karta PNG va PDF sifatida yuklab olindi!",
                downloadError: "Kartani yaratishda xato. Konsolni tekshiring.",
                uzbekFlag1: "O'ZBEKISTON RESPUBLIKASI",
                uzbekFlag2: "SHAXS GUVOHNOMASI",
                uzbekSurname: "Familiyasi / Surname",
                uzbekName: "Ismi / Given name",
                uzbekDob: "Tug'ilgan sana / Date of birth",
                uzbekSex: "Jinsi / Sex",
                uzbekIssueDate: "Berilgan sanasi / Date of issue",
                uzbekExpiryDate: "Amal qilish vaqti / Date of expiry",
                uzbekCardNumber: "Karta raqami / Card number",
                placeholderPhoto: "Rasm",
            }
        };

        // Map id -> translation key
        const elementsToTranslate = {
            'editorTitle': 'editorTitle',
            'previewTitle': 'previewTitle',
            'photoLabel': 'photoLabel',
            'surnameLabel': 'surnameLabel',
            'nameLabel': 'nameLabel',
            'dobLabel': 'dobLabel',
            'sexLabel': 'sexLabel',
            'issueDateLabel': 'issueDateLabel',
            'expiryDateLabel': 'expiryDateLabel',
            'cardNumberLabel': 'cardNumberLabel',
            'idUzbLabel': 'idUzbLabel',
            'downloadCardButton': 'downloadButton',
            'cardHeader1': 'uzbekFlag1',
            'cardHeader2': 'uzbekFlag2',
            'cardSurnameLabel': 'uzbekSurname',
            'cardNameLabel': 'uzbekName',
            'cardDobLabel': 'uzbekDob',
            'cardSexLabel': 'uzbekSex',
            'cardIssueDateLabel': 'uzbekIssueDate',
            'cardExpiryDateLabel': 'uzbekExpiryDate',
            'cardCardNumberLabel': 'uzbekCardNumber',
        };

        const languageSelector = document.getElementById('languageSelector');
        const cardStudentPhoto = document.getElementById('cardStudentPhoto');
        const surnameInput = document.getElementById('surnameInput');
        const nameInput = document.getElementById('nameInput');

        function formatDateForDisplay(dateValue) {
            if (!dateValue) return '';
            try {
                const d = new Date(dateValue);
                if (isNaN(d)) return '';
                const dd = String(d.getDate()).padStart(2, '0');
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const yyyy = d.getFullYear();
                return `${dd}.${mm}.${yyyy}`;
            } catch (e) { return dateValue; }
        }

        function sanitizeFileName(name) {
            return name.replace(/[^\w\-_. ]+/g, '').replace(/\s+/g, '_').slice(0, 120) || 'student';
        }

        function updateLanguage(lang) {
            const translation = translations[lang];
            if (!translation) return;
            for (const [id, key] of Object.entries(elementsToTranslate)) {
                const element = document.getElementById(id);
                if (element) {
                    // для кнопки используем value/textContent в зависимости от типа
                    element.textContent = translation[key] || '';
                }
            }
            const sexSelect = document.getElementById('sexInput');
            if (sexSelect) {
                sexSelect.options[0].textContent = translation.sexFemale;
                sexSelect.options[1].textContent = translation.sexMale;
            }
            const fileLabel = document.querySelector('label[for="studentPhotoUpload"].modern-button');
            if (fileLabel) fileLabel.textContent = translation.chooseFile;
            if (cardStudentPhoto && cardStudentPhoto.src.includes('placehold.co')) {
                cardStudentPhoto.src = `https://placehold.co/100x120/10B981/ffffff?text=${encodeURIComponent(translation.placeholderPhoto)}`;
            }
            updateAllCardText();
            localStorage.setItem('language', lang);
        }

        function saveToLocalStorage() {
            const data = {
                surname: surnameInput.value,
                name: nameInput.value,
                dob: document.getElementById('dobInput').value,
                sex: document.getElementById('sexInput').value,
                issueDate: document.getElementById('issueDateInput').value,
                expiryDate: document.getElementById('expiryDateInput').value,
                cardNumber: document.getElementById('cardNumberInput').value,
                idUzb: document.getElementById('idUzbInput').value,
                photo: cardStudentPhoto.src || ''
            };
            try { localStorage.setItem('idCardData', JSON.stringify(data)); } catch(e) { console.warn('LocalStorage save failed', e); }
        }

        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('idCardData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    surnameInput.value = data.surname || '';
                    nameInput.value = data.name || '';
                    document.getElementById('dobInput').value = data.dob || '';
                    document.getElementById('sexInput').value = data.sex || 'AYOL';
                    document.getElementById('issueDateInput').value = data.issueDate || '';
                    document.getElementById('expiryDateInput').value = data.expiryDate || '';
                    document.getElementById('cardNumberInput').value = data.cardNumber || '';
                    document.getElementById('idUzbInput').value = data.idUzb || 'ID UZB';
                    if (data.photo && data.photo !== cardStudentPhoto.src) {
                        cardStudentPhoto.src = data.photo;
                    }
                } catch (err) { console.warn('Invalid saved data', err); }
            }
            const savedLang = localStorage.getItem('language') || 'ru';
            languageSelector.value = savedLang;
            updateLanguage(savedLang);
        }

        function updateCardText(inputId, cardElementId) {
            const inputElement = document.getElementById(inputId);
            const cardElement = document.getElementById(cardElementId);
            if (!cardElement) return;
            if (!inputElement) { cardElement.textContent = ''; return; }

            if (inputElement.type === 'date') {
                cardElement.textContent = formatDateForDisplay(inputElement.value);
            } else if (inputElement.tagName === 'SELECT' && inputId === 'sexInput') {
                // Отображать локализованный текст пола
                const lang = localStorage.getItem('language') || 'ru';
                const trans = translations[lang] || translations.ru;
                const val = inputElement.value;
                if (val === 'AYOL') cardElement.textContent = trans.sexFemale;
                else if (val === 'ERKAK') cardElement.textContent = trans.sexMale;
                else cardElement.textContent = val;
            } else {
                cardElement.textContent = inputElement.value || '';
            }
        }

        function updateAllCardText() {
            updateCardText('surnameInput', 'cardSurname');
            updateCardText('nameInput', 'cardName');
            updateCardText('dobInput', 'cardDob');
            updateCardText('sexInput', 'cardSex');
            updateCardText('issueDateInput', 'cardIssueDate');
            updateCardText('expiryDateInput', 'cardExpiryDate');
            updateCardText('cardNumberInput', 'cardCardNumber');
            updateCardText('idUzbInput', 'cardIdUzb');
        }

        // модал
        function showMessage(message, type = 'info') {
            const overlay = document.getElementById('modalOverlay');
            const box = document.getElementById('modalBox');
            box.textContent = message;
            overlay.style.display = 'flex';
            setTimeout(() => box.classList.add('show'), 10);
            setTimeout(() => {
                box.classList.remove('show');
                setTimeout(() => overlay.style.display = 'none', 220);
            }, 2000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadFromLocalStorage();
            updateAllCardText();

            const inputs = document.querySelectorAll('input[type="text"], input[type="date"], select, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    updateAllCardText();
                    saveToLocalStorage();
                });
            });

            languageSelector.addEventListener('change', (e) => updateLanguage(e.target.value));

            // file upload
            document.getElementById('studentPhotoUpload').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(evt) {
                        cardStudentPhoto.src = evt.target.result;
                        saveToLocalStorage();
                    };
                    reader.readAsDataURL(file);
                }
            });

            // если пользователи кликают по кнопке выбора файла — это уже сработает через label[for]
        });

        // Захват + скачивание (PNG + PDF) — исправлено чтобы не обрезало
        document.getElementById('downloadCardButton').addEventListener('click', async () => {
            const card = document.getElementById('idCardPreview');
            const scaleFactor = 3; // качество: 2..4 - можно варьировать
            const currentLang = localStorage.getItem('language') || 'ru';
            const translation = translations[currentLang];

            try {
                showMessage(translation.creatingCard, "info");

                // временно позволим видеть полностью (избавимся от overflow:hidden, если он мешает)
                const prevOverflow = card.style.overflow;
                card.style.overflow = 'visible';

                // используем точную геометрию элемента
                const rect = card.getBoundingClientRect();

                // html2canvas capture - корректные параметры чтобы не обрезало
                const canvas = await html2canvas(card, {
                    scale: scaleFactor,
                    useCORS: true,
                    backgroundColor: null, // сохраняем белый фон карты (карта сама белая)
                    width: Math.round(rect.width),
                    height: Math.round(rect.height),
                    x: Math.round(rect.left + window.scrollX),
                    y: Math.round(rect.top + window.scrollY),
                    // исправления для некоторых браузеров
                    scrollX: 0,
                    scrollY: 0,
                    windowWidth: document.documentElement.clientWidth,
                    windowHeight: document.documentElement.clientHeight,
                });

                // восстановим overflow
                card.style.overflow = prevOverflow || '';

                // Создаём безопасное имя
                const rawName = (document.getElementById('nameInput').value || document.getElementById('surnameInput').value || 'student');
                const studentName = sanitizeFileName(rawName);

                // PNG
                const pngUrl = canvas.toDataURL('image/png');
                const pngLink = document.createElement('a');
                pngLink.href = pngUrl;
                pngLink.download = `${studentName}_id_card.png`;
                document.body.appendChild(pngLink);
                pngLink.click();
                document.body.removeChild(pngLink);

                // PDF
                const { jsPDF } = window.jspdf || window.jspdf || {};
                // Стандартный размер ID-1: 85.60 x 53.98 mm
                const pdfWidthMM = 85.60;
                const pdfHeightMM = 53.98;

                // если jsPDF доступен
                if (jsPDF) {
                    const pdf = new jsPDF({
                        orientation: 'landscape',
                        unit: 'mm',
                        format: [pdfWidthMM, pdfHeightMM]
                    });

                    // Для соотношения сторон используем пиксели canvas
                    const imgData = canvas.toDataURL('image/png');

                    // Вставляем изображение на всю страницу PDF в мм (он автоматически растянет)
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidthMM, pdfHeightMM);
                    pdf.save(`${studentName}_id_card.pdf`);
                } else {
                    console.warn('jsPDF not found, skipping PDF generation.');
                }

                setTimeout(() => showMessage(translation.downloadSuccess, "success"), 500);
                saveToLocalStorage();
            } catch (error) {
                console.error("Ошибка при создании карты:", error);
                showMessage((translations[localStorage.getItem('language')]||translations.ru).downloadError, "error");
            }
        });
    </script>
</body>
</html>
